<table
    *appLet="currentTime$ | async as currentTime"
    class="table table-striped"
>
    <thead>
        <tr>
            <th scope="col">Name</th>
            <th scope="col">Start</th>
            <th scope="col">Ziel</th>
            <!-- We now that this resolves synchronous -->
            <th
                *ngIf="exerciseStatus$ | async as exerciseStatus"
                scope="col"
                [class.text-muted]="exerciseStatus !== 'running'"
                [title]="
                    'Die Übung ist aktuell ' +
                    (exerciseStatus === 'running' ? 'aktiv' : 'pausiert')
                "
            >
                <i
                    [class.bi-pause-fill]="exerciseStatus !== 'running'"
                    [class.bi-play-fill]="exerciseStatus === 'running'"
                >
                </i>
                Ankunft in
            </th>
        </tr>
    </thead>
    <tbody>
        <!-- Vehicles -->
        <tr
            *ngFor="
                let vehicleTransfer of vehiclesInTransfer$ | async;
                trackBy: 'vehicle.id' | appTrackByProperty
            "
        >
            <td class="align-middle">
                {{ vehicleTransfer.vehicle.name }}
            </td>
            <td class="align-middle">
                <app-transfer-point-name
                    [transferPoint]="vehicleTransfer.startTransferPoint"
                ></app-transfer-point-name>
            </td>
            <td ngbDropdown class="align-middle">
                <button
                    type="button"
                    class="btn btn-sm btn-outline-primary dropdown-toggle"
                    ngbDropdownToggle
                >
                    <app-transfer-point-name
                        [transferPoint]="vehicleTransfer.targetTransferPoint"
                    ></app-transfer-point-name>
                </button>
                <div ngbDropdownMenu>
                    <button
                        *ngFor="
                            let transferPointKeyValue of transferPoints$
                                | async
                                | keyvalue
                        "
                        ngbDropdownItem
                        [disabled]="
                            transferPointKeyValue.key ===
                            vehicleTransfer.targetTransferPoint.id
                        "
                        (click)="
                            setTransferTarget(
                                'vehicles',
                                vehicleTransfer.vehicle.id,
                                transferPointKeyValue.key
                            )
                        "
                    >
                        <app-transfer-point-name
                            [transferPoint]="transferPointKeyValue.value"
                        ></app-transfer-point-name>
                    </button>
                </div>
            </td>
            <td class="align-middle">
                <div class="btn-group btn-group-sm">
                    <button
                        class="btn btn-small btn-outline-secondary"
                        title="1 Minute verkürzen"
                        (click)="
                            addTransferTime(
                                'vehicles',

                                vehicleTransfer.vehicle.id,
                                -60 * 1000
                            )
                        "
                    >
                        -
                    </button>
                    <button
                        class="btn btn-small btn-outline-secondary font-monospace fw-bold"
                        [class.text-dark]="
                            !vehicleTransfer.vehicle.transfer.isPaused
                        "
                        (click)="
                            togglePauseTransfer(
                                'vehicles',
                                vehicleTransfer.vehicle.id
                            )
                        "
                        [title]="
                            'Transfer ist ' +
                            (vehicleTransfer.vehicle.transfer.isPaused
                                ? 'pausiert'
                                : 'aktiv')
                        "
                    >
                        <i
                            [ngClass]="
                                vehicleTransfer.vehicle.transfer.isPaused
                                    ? 'bi-pause-fill'
                                    : 'bi-play-fill'
                            "
                        ></i>
                        {{
                            vehicleTransfer.vehicle.transfer!.endTimeStamp -
                                currentTime | formatDuration
                        }}
                    </button>
                    <button
                        class="btn btn-small btn-outline-secondary"
                        title="1 Minute verlängern"
                        (click)="
                            addTransferTime(
                                'vehicles',
                                vehicleTransfer.vehicle.id,
                                60 * 1000
                            )
                        "
                    >
                        +
                    </button>
                </div>
            </td>
        </tr>
        <!-- Personnel -->
        <tr
            *ngFor="
                let personnelTransfer of personnelInTransfer$ | async;
                trackBy: 'personnel.id' | appTrackByProperty
            "
        >
            <td class="align-middle">
                {{ personnelTransfer.personnel.vehicleName }}
                <span class="text-muted">
                    {{ personnelTransfer.personnel.personnelType }}
                </span>
            </td>
            <td class="align-middle">
                <app-transfer-point-name
                    [transferPoint]="personnelTransfer.startTransferPoint"
                ></app-transfer-point-name>
            </td>
            <td class="align-middle">
                <app-transfer-point-name
                    [transferPoint]="personnelTransfer.targetTransferPoint"
                ></app-transfer-point-name>
            </td>
            <td class="align-middle">
                {{
                    personnelTransfer.personnel.transfer!.endTimeStamp -
                        currentTime | formatDuration
                }}
            </td>
        </tr>
    </tbody>
</table>

<p
    *ngIf="
        (vehiclesInTransfer$ | async)?.length === 0 &&
        (personnelInTransfer$ | async)?.length === 0
    "
    class="text-muted text-center"
>
    Keine Rettungskräfte im Transfer
</p>
